#!/usr/bin/env bash

# ðŸš€ Debian 12 Server Optimization Script
# ðŸŽ¯ Objetivo: Hacer tu servidor ligero, rÃ¡pido y fÃ¡cil de administrar.
# ðŸ“ Funcionalidades:
#    ðŸ“¦ Backup de configuraciones
#    ðŸ›‘ Deshabilitar servicios innecesarios
#    ðŸ”„ Auto-upgrades
#    ðŸŽï¸ CPU Governor en "performance"
#    âš™ï¸ Ajustes sysctl personalizados
#    â° SincronizaciÃ³n horaria con Chrony
#    ðŸ”„ Rollback de cambios

set -euo pipefail
IFS=$'\n\t'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Variables y Colores
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SCRIPT_NAME="$(basename "$0")"
LOG_FILE="/var/log/optimize-debian.log"
BACKUP_ROOT_DEFAULT="/root/optimize-backup-$(date +%Y%m%d-%H%M%S)"

# Colores para mensajes
RED='\033[0;31m'    GREEN='\033[0;32m'
YELLOW='\033[1;33m' BLUE='\033[0;34m'
NC='\033[0m'        # No Color

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Funciones de registro
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
log()  { echo -e "${GREEN}[INFO]  [$(date +'%F %T')]${NC} $*"  | tee -a "$LOG_FILE"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $*" | tee -a "$LOG_FILE"; }
err()  { echo -e "${RED}[ERROR]${NC} $*" | tee -a "$LOG_FILE"; }

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Verificaciones iniciales
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ensure_root() {
  if [[ $EUID -ne 0 ]]; then
    err "Ejecuta como root o con sudo."
    exit 1
  fi
}

check_cmd() {
  command -v "$1" >/dev/null 2>&1 || { err "Falta comando '$1'. InstÃ¡lalo primero."; exit 1; }
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ“¦ Backup de configuraciones crÃ­ticas
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
backup_configs() {
  BACKUP_ROOT="${1:-$BACKUP_ROOT_DEFAULT}"
  log "Creando backup en $BACKUP_ROOT"
  mkdir -p "$BACKUP_ROOT"/{sysctl,cpufreq,chrony,apt,services}
  systemctl list-unit-files --type=service --state=enabled \
    > "$BACKUP_ROOT/services/enabled-services.txt"
  cp /etc/sysctl.d/99-custom.conf    "$BACKUP_ROOT/sysctl/"    2>/dev/null || warn "sysctl no existe"
  cp /etc/default/cpufrequtils       "$BACKUP_ROOT/cpufreq/"   2>/dev/null || warn "cpufrequtils no existe"
  cp /etc/chrony/chrony.conf         "$BACKUP_ROOT/chrony/"    2>/dev/null || warn "chrony.conf no existe"
  cp /etc/apt/apt.conf.d/50unattended-upgrades \
                                      "$BACKUP_ROOT/apt/"       2>/dev/null || warn "unattended-upgrades conf no existe"
  log "Backup completado"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ”„ Rollback de Ãºltima configuraciÃ³n
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
rollback() {
  local BACKUP_DIR
  BACKUP_DIR=$(ls -td /root/optimize-backup-* 2>/dev/null | head -n1)
  if [[ -z "$BACKUP_DIR" || ! -d "$BACKUP_DIR" ]]; then
    err "No se encontrÃ³ backup."
    exit 1
  fi
  log "Restaurando desde $BACKUP_DIR"
  while read -r svc; do
    systemctl enable --now "$svc" 2>/dev/null || warn "No pudo habilitar $svc"
  done < "$BACKUP_DIR/services/enabled-services.txt"
  cp "$BACKUP_DIR/sysctl/99-custom.conf"      /etc/sysctl.d/       2>/dev/null || warn
  cp "$BACKUP_DIR/cpufreq/cpufrequtils"       /etc/default/        2>/dev/null || warn
  cp "$BACKUP_DIR/chrony/chrony.conf"         /etc/chrony/         2>/dev/null || warn
  cp "$BACKUP_DIR/apt/50unattended-upgrades"  /etc/apt/apt.conf.d/ 2>/dev/null || warn
  systemctl daemon-reload
  sysctl --system || warn
  systemctl restart cpufrequtils chrony || warn
  log "Rollback completado"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ›‘ Deshabilitar servicios innecesarios (Interactivo)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
disable_services_interactive() {
  # 1) Recoge servicios .service habilitados
  local svcs svc
  mapfile -t svcs < <(
    systemctl list-unit-files --type=service --state=enabled \
      --no-legend --no-pager \
      | awk '{print $1}' | sort
  )

  if [[ ${#svcs[@]} -eq 0 ]]; then
    log "No hay servicios .service habilitados para mostrar."
    return
  fi

  # 2) Muestra menÃº de selecciÃ³n
  echo -e "${BLUE}Selecciona servicios a deshabilitar (enter para terminar):${NC}"
  select svc in "[Terminar]" "${svcs[@]}"; do
    if [[ "$svc" == "[Terminar]" ]]; then
      log "SelecciÃ³n finalizada."
      break
    fi
    if [[ -z "$svc" ]]; then
      warn "OpciÃ³n invÃ¡lida, intenta de nuevo."
      continue
    fi
    # 3) ConfirmaciÃ³n
    read -rp "Â¿Deshabilitar $svc? (y/N): " ans
    if [[ "$ans" =~ ^[Yy]$ ]]; then
      systemctl disable --now "$svc"
      log "$svc deshabilitado"
    else
      log "$svc conservado"
    fi
  done
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ”„ Configurar unattended-upgrades
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
config_unattended() {
  log "Instalando unattended-upgrades"
  apt update
  DEBIAN_FRONTEND=noninteractive apt install -y unattended-upgrades apt-listchanges
  cat >/etc/apt/apt.conf.d/20auto-upgrades <<EOF
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Unattended-Upgrade "1";
EOF
  dpkg-reconfigure --frontend=noninteractive unattended-upgrades
  log "Auto-upgrades configurado"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸŽï¸ Configurar CPU Governor
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
config_cpu_governor() {
  log "Configurando CPU governor a performance"
  apt install -y cpufrequtils
  cat >/etc/default/cpufrequtils <<EOF
GOVERNOR="performance"
EOF
  systemctl enable cpufrequtils
  systemctl restart cpufrequtils
  log "CPU governor listo"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âš™ï¸ Ajustes sysctl personalizados
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
config_sysctl() {
  log "Aplicando ajustes sysctl"
  cat >/etc/sysctl.d/99-custom.conf <<EOF
vm.swappiness=10
vm.vfs_cache_pressure=50
net.core.netdev_max_backlog=2000
net.core.somaxconn=1024
fs.file-max=100000
EOF
  sysctl --system
  log "Sysctl aplicado"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â° Configurar Chrony (sin systemd-timesyncd)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
config_chrony() {
  log "Instalando y configurando Chrony"
  apt install -y chrony
  systemctl disable --now systemd-timesyncd.service || true
  systemctl enable --now chrony
  log "Chrony activo"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ“Š MenÃº principal interactivo
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
show_menu() {
  cat <<EOF

${BLUE}=== MenÃº de OptimizaciÃ³n Debian 12 ===${NC}
1) ðŸ“¦ Backup de configuraciones
2) ðŸ›‘ Deshabilitar servicios interactivos
3) ðŸ”„ Configurar auto-upgrades
4) ðŸŽï¸ Configurar CPU governor
5) âš™ï¸ Aplicar ajustes sysctl
6) â° Configurar Chrony
7) ðŸš€ Ejecutar todo (1-6)
8) ðŸ”„ Rollback al Ãºltimo backup
9) âŒ Salir
EOF
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
main() {
  ensure_root
  check_cmd systemctl
  check_cmd apt
  check_cmd sysctl

  while true; do
    show_menu
    read -rp "Elige una opciÃ³n [1-9]: " opt
    case "$opt" in
      1) backup_configs ;;
      2) disable_services_interactive ;;
      3) config_unattended ;;
      4) config_cpu_governor ;;
      5) config_sysctl ;;
      6) config_chrony ;;
      7) backup_configs && disable_services_interactive && config_unattended && \
                         config_cpu_governor && config_sysctl && config_chrony ;;
      8) rollback ;;
      9) log "Saliendoâ€¦"; exit 0 ;;
      *) warn "OpciÃ³n invÃ¡lida." ;;
    esac
  done
}

main "$@"
